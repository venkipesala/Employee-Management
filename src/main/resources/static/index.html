<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* Search Bar */

    .search-bar {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    }

    .search-bar input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    }

    .search-bar button {
    padding: 8px 14px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    }

    .search-bar button:hover {
    background: #1d4ed8;
    }

    #deptPagination {
    margin: 15px 0;
    text-align: center;
    }

    #deptPagination button {
    margin: 0 3px;
    padding: 6px 10px;
    border: 1px solid #2563eb;
    background: white;
    color: #2563eb;
    border-radius: 4px;
    cursor: pointer;
    }

    #deptPagination button:hover {
    background: #2563eb;
    color: white;
    }

    #deptPagination button.active-page {
    background: #2563eb;
    color: white;
    font-weight: bold;
    }

    /* Pagination */

    #empPagination {
    margin: 15px 0;
    text-align: center;
    }

    #empPagination button {
    margin: 0 3px;
    padding: 6px 10px;
    border: 1px solid #2563eb;
    background: white;
    color: #2563eb;
    border-radius: 4px;
    cursor: pointer;
    }

    #empPagination button:hover {
    background: #2563eb;
    color: white;
    }

    #empPagination button.active-page {
    background: #2563eb;
    color: white;
    font-weight: bold;
    }

        body {
          font-family: Arial, sans-serif;
          background: #f4f6f9;
          margin: 0;
          padding: 0;
        }

        header {
          background: #2563eb;
          color: white;
          padding: 15px;
          text-align: center;
        }

        nav {
          display: flex;
          justify-content: center;
          background: #1e40af;
        }

        nav button {
          background: transparent;
          color: white;
          border: none;
          padding: 12px 20px;
          cursor: pointer;
          font-size: 15px;
        }

        nav button:hover,
        nav button.active {
          background: #3b82f6;
        }

        .container {
          max-width: 1000px;
          margin: 20px auto;
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h2 {
          margin-top: 0;
          color: #1e3a8a;
        }

        form {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
        }

        form input, form button {
          padding: 8px;
          font-size: 14px;
        }

        form button {
          background: #2563eb;
          color: white;
          border: none;
          cursor: pointer;
          border-radius: 4px;
        }

        form button:hover {
          background: #1d4ed8;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        table th, table td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: center;
        }

        table th {
          background: #eff6ff;
        }

        .hidden {
          display: none;
        }

        .btn-delete {
          background: #dc2626;
          color: white;
          border: none;
          padding: 5px 8px;
          cursor: pointer;
        }

        .btn-edit {
          background: #16a34a;
          color: white;
          border: none;
          padding: 5px 8px;
          cursor: pointer;
          margin-right: 5px;
        }

        .btn-assignemp {
          background: #2563eb;
          color: white;
          border: none;
          padding: 5px 8px;
          cursor: pointer;
        }

        .btn-clear {
          background: #6b7280;
          color: white;
          border: none;
          padding: 6px 10px;
          cursor: pointer;
          border-radius: 4px;
        }
    /* Modal */

    .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    }

    .modal-content {
    background: white;
    width: 500px;
    margin: 10% auto;
    padding: 20px;
    border-radius: 8px;
    }

    </style>
</head>
<body>

<header>
    <h1>Employee ‚Äì Department Management</h1>
</header>

<nav>
    <button class="active" onclick="showSection('employee', event)">Employees</button>
    <button onclick="showSection('department', event)">Departments</button>
    <button onclick="showSection('project', event)">Projects</button>
</nav>

<!-- ================= EMPLOYEE SECTION ================= -->
<div class="container" id="employee-section">
    <h2>Employee Management</h2>

    <div style="margin-bottom:10px;">
        <button onclick="showAllEmployees()">Show All Employees</button>
        <!--button onclick="clearEmployeeTable()">Clear Table</button-->
    </div>

    <form id="employeeForm">
        <input type="hidden" id="empId">

        <input type="text" id="empName" placeholder="Name" required>
        <input type="email" id="empEmail" placeholder="Email" required>
        <!--input type="text" id="empDept" placeholder="Department" required-->
        <select id="empDept"></select>
        <input type="text" id="empPhone" placeholder="Phone" required>

        <button type="submit">Add/Save Employee</button>
        <button type="button" class="btn-clear" onclick="clearEmployeeForm()">Clear</button>
    </form>

    <div class="search-bar">

        <input
                type="text"
                id="empSearch"
                placeholder="Search by name or email...">

        <button onclick="searchEmployees()">
            üîç Search
        </button>

        <button onclick="showAllEmployees()">
            üîÑ Reset
        </button>

    </div>


    <div id="empPagination"></div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Phone</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
    </table>
</div>

<!-- ================= DEPARTMENT SECTION ================= -->
<div class="container hidden" id="department-section">
    <h2>Department Management</h2>

    <div style="margin-bottom:10px;">
        <button onclick="loadDepartments(0)">Show All Departments</button>
        <button onclick="clearDeptTable()">Clear Table</button>
    </div>

    <form id="deptForm">
        <input type="hidden" id="deptId">

        <input type="text" id="deptName" placeholder="Department Name" required>
        <input type="text" id="deptLocation" placeholder="Location" required>

        <button type="submit">Add/Save Department</button>
        <button type="button" class="btn-clear" onclick="clearDeptForm()">Clear</button>
    </form>

    <div id="deptPagination"></div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Location</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="deptTable"></tbody>
    </table>

</div>

<!-- ================= ASSIGN MODAL ================= -->

<div id="assignModal" class="modal">

    <div class="modal-content">

        <h3 id="assignTitle"></h3>

        <input type="text"
               id="assignSearch"
               placeholder="Search employees...">

        <div id="assignList"></div>

        <div style="margin-top:10px;text-align:right">

            <button onclick="saveAssign()">
                Save
            </button>

            <button onclick="closeAssign()">
                Cancel
            </button>

        </div>

    </div>
</div>

<!-- ================= PROJECT SECTION ================= -->

<div class="container hidden" id="project-section">

    <h2>Project Management</h2>

    <div style="margin-bottom:10px;">
        <button onclick="loadProjects()">Show All Projects</button>
    </div>

    <form id="projectForm">

        <input type="hidden" id="projectId">

        <input type="text"
               id="projectName"
               placeholder="Project Name"
               required>

        <select id="projectStatus">
            <option value="NEW">NEW</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="COMPLETED">COMPLETED</option>
        </select>

        <input type="date" id="projectStart">

        <input type="date" id="projectEnd">

        <!-- Assign Employees -->
        <select id="projectEmployees" multiple>
            <!-- Loaded dynamically -->
        </select>

        <button type="submit">Save Project</button>

        <button type="button"
                class="btn-clear"
                onclick="clearProjectForm()">
            Clear
        </button>

    </form>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Status</th>
            <th>Employees</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="projectTable"></tbody>
    </table>

</div>

<script>
    /* ================= API CONFIG ================= */

    const API = {
      EMP: '/api/employees',
      DEPT: '/api/departments',
      PROJ: '/api/projects'
    };

    let assignDeptId = null;
    let currentDeptId = null;

    /* ================= NAVIGATION ================= */

    function showSection(section, event) {

      document
        .querySelectorAll('.container')
        .forEach(div => div.classList.add('hidden'));

      document
        .getElementById(section + '-section')
        .classList.remove('hidden');

      document
        .querySelectorAll('nav button')
        .forEach(btn => btn.classList.remove('active'));

      event.target.classList.add('active');

      if (section === 'project') {
        loadProjectEmployees();
        loadProjects();
      }
    }


    /* ================= COMMON API ================= */

    async function apiCall(url, method = 'GET', data = null) {

      const options = {
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      const res = await fetch(url, options);

      if (!res.ok) {
        throw new Error('API Error');
      }

      const text = await res.text();

      return text ? JSON.parse(text) : null;
    }

   /* ================= EMPLOYEE ================= */

  let empPage = 0;
  const empSize = 5;

  document.getElementById('employeeForm')
  .addEventListener('submit', async e => {

  e.preventDefault();

  const emp = {
    name: empName.value,
    email: empEmail.value,
    deptId: empDept.value,
    phone: empPhone.value
  };

  const id = empId.value;

  if (id) {
    await apiCall(`${API.EMP}/${id}`, 'PUT', emp);
  } else {
    await apiCall(API.EMP, 'POST', emp);
  }

  clearEmployeeForm();
  loadEmployees(0);
  });

  function editEmployee(e) {

  empId.value = e.id;
  empName.value = e.name;
  empEmail.value = e.email;
  empDept.value = e.department?.id || '';
  empPhone.value = e.phone;
  }


  async function deleteEmployee(id) {

  if (!confirm('Delete employee?')) return;

  await apiCall(`${API.EMP}/${id}`, 'DELETE');

  loadEmployees(empPage);
  }

  function clearEmployeeForm() {
  empId.value = '';
  document.getElementById('employeeForm').reset();
  }


  async function loadEmployees(page = 0) {

  empPage = page;

  const search =
  document.getElementById('empSearch').value || '';

  const key = encodeURIComponent(search);

  const data = await apiCall(
    `${API.EMP}?page=${page}&size=${empSize}&search=${key}`
  );


  const list = data.content;

  const tbody =
  document.getElementById('employeeTable');

  tbody.innerHTML = '';

  if (!list || !list.length) {

  tbody.innerHTML =
    '<tr><td colspan="6">No Employees</td></tr>';

  return;
  }

  list.forEach(e => {

  tbody.innerHTML += `
    <tr>
      <td>${e.id}</td>
      <td>${e.name}</td>
      <td>${e.email}</td>
      <td>${e.department?.name || 'N/A'}</td>
      <td>${e.phone}</td>

      <td>
        <button class="btn-edit"
          onclick='editEmployee(${JSON.stringify(e)})'>
          Edit
        </button>

        <button class="btn-delete"
          onclick='deleteEmployee(${e.id})'>
          Delete
        </button>
      </td>
    </tr>
  `;
  });

  renderEmpPagination(data.totalPages);
  }


  function searchEmployees() {
  loadEmployees(0);
  }


  function renderEmpPagination(totalPages) {

  const div =
  document.getElementById('empPagination');

  div.innerHTML = '';

  for (let i = 0; i < totalPages; i++) {

  const btn = document.createElement('button');

  btn.textContent = i + 1;

  if (i === empPage) {
    btn.classList.add('active-page');
  }

  btn.onclick = () => loadEmployees(i);

  div.appendChild(btn);
  }
  }


    /* ================= DEPARTMENT ================= */

  /* ================= DEPARTMENT ================= */

  let deptPage = 0;
  const deptSize = 5;


  async function loadDepartments(page = 0) {
  deptPage = page;
  const data = await apiCall(
  `${API.DEPT}?page=${page}&size=${deptSize}`
  );
  const list = data.content;
  const tbody =
  document.getElementById('deptTable');

  tbody.innerHTML = '';
  if (!list || !list.length) {
  tbody.innerHTML =
    '<tr><td colspan="4">No Departments</td></tr>';
  return;
  }

  list.forEach(d => {
  tbody.innerHTML += `
    <tr>
      <td>${d.id}</td>
      <td>${d.name}</td>
      <td>${d.location}</td>

      <td>
       <button class="btn-edit"
        onclick='editDept(${JSON.stringify(d)})'>
        Edit
       </button>

      <button class="btn-assignemp"
        onclick="openAssign(${d.id}, '${d.name}')">
        Assign Employees
      </button>

      <button class="btn-delete"
        onclick="deleteDept(${d.id})">
        Delete
      </button>
      </td>
    </tr>
  `;
  });
  renderDeptPagination(data.totalPages);
  }

  function renderDeptPagination(totalPages) {

  const div =
  document.getElementById('deptPagination');

  div.innerHTML = '';

  for (let i = 0; i < totalPages; i++) {

  const btn = document.createElement('button');

  btn.textContent = i + 1;

  if (i === deptPage) {
    btn.classList.add('active-page');
  }

  btn.onclick = () => loadDepartments(i);

  div.appendChild(btn);
  }
  }

  function editDept(d) {
  deptId.value = d.id;
  deptName.value = d.name;
  deptLocation.value = d.location;

  currentDeptId = d.id;

  loadDeptEmployees('');
  }

document.getElementById('deptForm')
  .addEventListener('submit', async e => {

    e.preventDefault();

    const dept = {
      name: deptName.value,
      location: deptLocation.value
    };

    const id = deptId.value;

    if (id) {
      await apiCall(`${API.DEPT}/${id}`, 'PUT', dept);
    } else {
      await apiCall(API.DEPT, 'POST', dept);
    }

    clearDeptForm();
    loadDepartments(0);

});




    /* ================= PROJECT ================= */

    async function loadProjectEmployees() {

      const emps = await apiCall(API.EMP);

      const select =
        document.getElementById('projectEmployees');

      select.innerHTML = '';

      emps.content.forEach(e => {

        select.innerHTML +=
          `<option value="${e.id}">
            ${e.name}
          </option>`;
      });
    }


    async function loadProjects() {

      const projects = await apiCall(API.PROJ);

      const tbody =
        document.getElementById('projectTable');

      tbody.innerHTML = '';

      if (!projects || !projects.length) {

        tbody.innerHTML =
          '<tr><td colspan="5">No Data</td></tr>';

        return;
      }

      projects.forEach(p => {

        const empNames =
          p.employees?.map(e => e.name).join(', ') || '';

        tbody.innerHTML += `
          <tr>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.status}</td>
            <td>${empNames}</td>
            <td>
              <button class="btn-delete"
                onclick="deleteProject(${p.id})">
                Delete
              </button>
            </td>
          </tr>
        `;
      });
    }


    document.getElementById('projectForm')
      .addEventListener('submit', async e => {

        e.preventDefault();

        const empIds =
          [...projectEmployees.selectedOptions]
            .map(o => o.value);

        const project = {
          name: projectName.value,
          status: projectStatus.value,
          startDate: projectStart.value,
          endDate: projectEnd.value,
          employeeIds: empIds
        };

        const id = projectId.value;

        if (id) {
          await apiCall(`${API.PROJ}/${id}`, 'PUT', project);
        } else {
          await apiCall(API.PROJ, 'POST', project);
        }

        clearProjectForm();
        loadProjects();
      });


    async function deleteProject(id) {

      if (!confirm('Delete project?')) return;

      await apiCall(`${API.PROJ}/${id}`, 'DELETE');

      loadProjects();
    }


    function clearProjectForm() {

      projectId.value = '';
      document.getElementById('projectForm').reset();
    }

  async function loadDeptDropdown() {

  const data = await apiCall(`${API.DEPT}?page=0&size=100`);

  const depts = data.content;

  const select =
  document.getElementById('empDept');

  select.innerHTML =
  '<option value="">Select</option>';

  if (!depts) return;

  depts.forEach(d => {

  select.innerHTML +=
    `<option value="${d.id}">
      ${d.name}
    </option>`;
  });
  }

    /* ================= INIT ================= */

    window.onload = () => {

      loadDeptDropdown();
      loadEmployees(0);
    };

  function clearDeptTable() {
  document.getElementById('deptTable').innerHTML = '';
  }

  function showAllEmployees() {

  // Clear search box
  document.getElementById('empSearch').value = '';

  // Reload first page
  loadEmployees(0);
  }

  async function loadDeptEmployees(search) {

    if (!currentDeptId) return;

    const data = await apiCall(
      `/api/employees?search=${search}&page=0&size=10`
    );

    const list = data.content;

    const div =
      document.getElementById('deptEmpResults');

    div.innerHTML = '';

    list.forEach(e => {

      const checked =
        e.department?.id === currentDeptId
          ? 'checked' : '';

      div.innerHTML += `
        <label>
          <input type="checkbox"
                 value="${e.id}"
                 ${checked}>
          ${e.name} (${e.email})
        </label><br>
      `;
    });
  }

  async function saveDeptEmployees() {

    if (!currentDeptId) {
      alert('Select department first');
      return;
    }

    const ids =
      [...document.querySelectorAll(
        '#deptEmpResults input:checked'
      )]
      .map(i => i.value);

    await apiCall(
      `/api/departments/${currentDeptId}/employees`,
      'PUT',
      ids
    );

    alert('Employees Assigned');
  }

  function clearDeptForm() {

  deptId.value = '';
  document.getElementById('deptForm').reset();

  currentDeptId = null;

  document.getElementById('deptEmpResults').innerHTML = '';
  }

  async function openAssign(id, name) {
    assignDeptId = id;

    document.getElementById('assignTitle')
      .innerText = `Assign Employees to ${name}`;

    document.getElementById('assignSearch').value = '';

    await loadAssignEmployees('');

    document.getElementById('assignModal')
      .style.display = 'block';
  }

  function closeAssign() {
    document.getElementById('assignModal')
      .style.display = 'none';

    assignDeptId = null;
  }

  /* ================= ASSIGN MODAL ================= */

  async function loadAssignEmployees(search) {

  if (!assignDeptId) return;

  const data = await apiCall(
  `/api/employees?search=${search}&page=0&size=20`
  );

  const list = data.content;

  const div =
  document.getElementById('assignList');

  div.innerHTML = '';

  list.forEach(e => {

  const checked =
    e.department?.id === assignDeptId
      ? 'checked' : '';

  div.innerHTML += `
    <label>
      <input type="checkbox"
             value="${e.id}"
             ${checked}>
      ${e.name} (${e.email})
    </label><br>
  `;
  });
  }

  /* Save assignment */

  async function saveAssign() {
    if (!assignDeptId) return;

    const ids =
    [...document.querySelectorAll(
      '#assignList input:checked'
    )]
    .map(i => i.value);

    await apiCall(
    `/api/departments/${assignDeptId}/employees`,
    'PUT',
    ids
    );

    alert('Employees Assigned');

    closeAssign();

    loadDepartments(deptPage);
  }

  // ================= SAFE EVENT BINDING =================

window.addEventListener("load", () => {
  // Department employee search
  const deptSearch =
    document.getElementById("deptEmpSearch");

  if (deptSearch) {
    deptSearch.addEventListener("input", e => {
      const q = e.target.value;
      if (q.length < 2) {
        loadDeptEmployees('');
        return;
      }
      loadDeptEmployees(q);
    });
  }

  // Assign modal search
  const assignSearch =
    document.getElementById("assignSearch");

  if (assignSearch) {
    assignSearch.addEventListener("input", e => {
      loadAssignEmployees(e.target.value);
    });
  }
});

</script>

</body>
</html>